// Generated by CoffeeScript 1.9.2

/*

 sync events are fired at these times
 page loads
 storage event
 page unload? 
 tab crashed?
 */
var aa, init;

init = function(name, callback) {
  var done, handleData;
  $(window).on('storage', function(e) {
    var key, newValue, oldValue;
    key = e.originalEvent.key;
    newValue = e.originalEvent.newValue;
    oldValue = e.originalEvent.oldValue;
    return $(window).trigger("tabHub." + key, newValue);
  });
  handleData = function(eventData) {
    return console.log("dataReceived: " + eventData + " " + document.title);
  };
  done = function(data) {
    console.log("done called " + document.title);
    localStorage.setItem(name, "data:" + data);
    return handleData(data);
  };
  $(window).on("tabHub." + name, function(e, newValue) {
    var eventArr, eventData, eventType;
    if (!newValue) {
      return;
    }
    eventArr = newValue.split(':');
    eventType = eventArr[0];
    eventData = eventArr[1];
    switch (eventType) {
      case 'readable':
        localStorage.setItem(name, 'pending:');
        return callback(done);
      case 'pending':
        break;
      case 'data':
        return handleData(eventData);
      case 'request':
        return localStorage.setItem(name, 'data:1111');
    }
  });
  return {
    run: function() {
      localStorage.removeItem(name);
      localStorage.setItem(name, 'request');
      return console.log(localStorage.getItem(name));
    },
    destory: function() {
      return $(window).off("tabHub." + name);
    }
  };
};

aa = init('aa', function (done, fail) {
            
    setTimeout(function() {
        
        done('123123123');
        
    }, 1000);
});;

aa.run();
